# 本地机器拍照上传指南

## 📸 使用场景

**你的情况**:
- **服务器**: Dell Precision 7920（没有摄像头）运行识别服务
- **本地机器**: 你当前使用的电脑（有摄像头）需要拍照识别

**解决方案**: 在本地机器拍照 → 自动上传到服务器 → 服务器识别 → 返回结果

---

## 🚀 快速开始（3步完成）

### 步骤1: 确认服务器正在运行

在**服务器**上执行：
```bash
curl http://localhost:8001/health
```

应该看到：
```json
{"status":"healthy","known_faces_count":1001}
```

✅ 如果正常，继续步骤2
❌ 如果失败，运行：`./start_service.sh`

---

### 步骤2: 在本地机器打开客户端页面

**在你当前的机器（有摄像头的电脑）上**，打开浏览器访问：

```
http://192.168.111.172:8001/static/local_camera_client.html
```

**重要**:
- ✅ 使用 **Chrome** / **Edge** / **Firefox** 浏览器
- ✅ 确保本地机器与服务器在**同一WiFi/局域网**
- ❌ 不要使用IE浏览器

---

### 步骤3: 拍照并识别

1. **启动摄像头**
   - 点击页面上的"**启动本地摄像头**"按钮
   - 浏览器会弹出权限请求，点击"**允许**"

2. **调整姿势**
   - 看向摄像头
   - 确保光线充足
   - 正面拍摄效果最好

3. **拍照识别**
   - 点击"**拍照并识别**"按钮
   - 照片会自动上传到服务器
   - 等待2-5秒

4. **查看结果**
   - 页面下方会显示识别结果
   - 如果是已知人脸，显示名字
   - 如果是陌生人，显示"Unknown"

---

## 📱 工作原理

```
┌─────────────────┐         ┌─────────────────┐
│   本地机器       │         │    服务器        │
│  (有摄像头)      │         │  (无摄像头)      │
└─────────────────┘         └─────────────────┘
        │                            │
        │ 1. 打开网页                │
        ├───────────────────────────>│
        │                            │
        │ 2. 启动本地摄像头          │
        │   (浏览器调用摄像头)       │
        │                            │
        │ 3. 拍照(本地)              │
        │                            │
        │ 4. 上传照片到服务器        │
        ├───────────────────────────>│
        │                            │
        │                     5. 服务器识别
        │                     (比对1001个人脸)
        │                            │
        │ 6. 返回识别结果            │
        │<───────────────────────────┤
        │                            │
        │ 7. 显示结果                │
        │   (姓名或Unknown)          │
        │                            │
```

**优点**:
- ✅ 本地摄像头采集，画质清晰
- ✅ 服务器强大算力识别
- ✅ 支持手机、平板、笔记本
- ✅ 无需安装任何软件

---

## 🖥️ 详细操作演示

### 界面说明

打开页面后，你会看到：

```
┌─────────────────────────────────────────┐
│  本地摄像头采集客户端                     │
│  在本地采集照片 → 上传到服务器识别         │
├─────────────────────────────────────────┤
│                                         │
│  ⚙️ 服务器配置                           │
│  服务器地址: [http://192.168.111.172:8001]│
│  💡 提示: 填写你的服务器IP地址和端口      │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│         [摄像头预览区域]                 │
│         (黑色背景)                       │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│  [启动本地摄像头] [拍照并识别] [停止]     │
│                                         │
│  准备就绪                                │
│                                         │
│  识别结果                                │
│  (这里会显示识别结果)                     │
│                                         │
└─────────────────────────────────────────┘
```

---

### 操作步骤详解

#### 1. 确认服务器地址

页面默认已填写：`http://192.168.111.172:8001`

**如果服务器IP不对**，请修改为正确的IP：
```bash
# 在服务器上查看IP
ip addr | grep "inet 192"

# 输出示例:
# inet 192.168.111.172/24
```

#### 2. 启动摄像头

点击"**启动本地摄像头**"按钮

**第一次使用**，浏览器会弹出权限请求：

**Chrome**:
```
192.168.111.172:8001 想要
使用您的摄像头

[阻止] [允许]  ← 点击"允许"
```

**Firefox**:
```
192.168.111.172:8001 想要使用您的摄像头

[拒绝] [允许]  ← 点击"允许"
```

点击"**允许**"后，摄像头会启动，你会看到自己的实时画面。

#### 3. 拍照

- 调整姿势，正对摄像头
- 确保光线充足
- 点击"**拍照并识别**"按钮

**状态提示**:
```
正在拍照...
正在上传到服务器识别...
识别成功！检测到 1 张人脸
```

#### 4. 查看结果

页面下方会显示：

**如果识别成功**:
```
识别结果
────────────
[照片缩略图]

检测到 1 张人脸:

人脸 1: 小徐
位置: Top=120, Left=150
```

**如果是陌生人**:
```
识别结果
────────────
[照片缩略图]

检测到 1 张人脸:

人脸 1: Unknown
位置: Top=120, Left=150
```

---

## 📱 支持的设备

### ✅ 完全支持

| 设备类型 | 浏览器 | 说明 |
|---------|--------|------|
| **Windows笔记本** | Chrome, Edge, Firefox | 推荐 |
| **MacBook** | Chrome, Safari, Firefox | 推荐 |
| **Android手机** | Chrome | 需要同一WiFi |
| **iPhone/iPad** | Safari | 需要同一WiFi |
| **Linux笔记本** | Chrome, Firefox | 推荐 |

### ⚠️ 部分支持

| 设备类型 | 限制 |
|---------|------|
| **台式机（无摄像头）** | 需要外接USB摄像头 |
| **旧版浏览器** | 需要更新浏览器 |

### ❌ 不支持

| 设备类型 | 原因 |
|---------|------|
| **IE浏览器** | 不支持WebRTC |
| **微信内置浏览器** | 权限限制 |

---

## 🔧 故障排除

### 问题1: 摄像头无法启动

**症状**: 点击"启动本地摄像头"后，黑屏或报错

**可能原因**:
1. 未授予摄像头权限
2. 摄像头被其他程序占用
3. 浏览器不支持

**解决方案**:

#### 检查权限（Chrome）
1. 点击地址栏左侧的"锁"图标
2. 找到"摄像头"权限
3. 选择"允许"
4. 刷新页面重试

#### 检查权限（Firefox）
1. 点击地址栏左侧的"盾牌"图标
2. 点击"权限"
3. 找到"摄像头"
4. 选择"允许"
5. 刷新页面重试

#### 检查是否被占用
关闭以下程序后重试：
- Zoom
- Microsoft Teams
- Skype
- 其他视频会议软件

#### 更新浏览器
确保使用最新版本：
- Chrome: 版本 88+
- Firefox: 版本 78+
- Edge: 版本 88+
- Safari: 版本 14+

---

### 问题2: 无法连接到服务器

**症状**: "识别失败: Failed to fetch"

**可能原因**:
1. 服务器地址错误
2. 服务器未运行
3. 不在同一网络

**解决方案**:

#### 检查服务器地址
确认填写的地址是否正确：
```
http://192.168.111.172:8001
```

#### 检查服务器状态（在服务器上执行）
```bash
# 检查服务是否运行
curl http://localhost:8001/health

# 检查端口是否监听
ss -tlnp | grep 8001
```

#### 检查网络连接（在本地机器执行）
```bash
# Windows
ping 192.168.111.172

# Mac/Linux
ping -c 4 192.168.111.172

# 测试端口连通性
curl http://192.168.111.172:8001/health
```

#### 确认同一网络
```bash
# 在本地机器查看IP
# Windows: ipconfig
# Mac/Linux: ip addr

# 确保IP前三段相同
# 服务器: 192.168.111.172
# 本地机: 192.168.111.xxx  ← 前三段应该相同
```

---

### 问题3: 识别速度慢

**症状**: 拍照后等待很久才返回结果

**原因**:
- 服务器需要在1001个人脸中搜索匹配
- 当前使用CPU模式（较慢）

**正常速度**: 2-5秒

**如果超过10秒**:
- 检查服务器负载：`top`
- 检查网络延迟：`ping 192.168.111.172`
- 考虑减少人脸数据库大小

---

### 问题4: 识别结果不准确

**症状**: 识别错误或总是显示Unknown

**原因**:
- 当前tolerance=0.5（较严格）
- 照片质量问题
- 光线不足

**优化建议**:
1. **改善拍照条件**:
   - ✅ 正面拍摄
   - ✅ 光线充足
   - ✅ 避免遮挡（口罩、墨镜、头发）
   - ✅ 距离适中（0.5-1米）

2. **调整识别阈值**:
   - 编辑 `face_detector.py` 第80行
   - 当前: `tolerance=0.5`
   - 宽松: `tolerance=0.6`（更容易识别）
   - 严格: `tolerance=0.4`（更难识别）

---

## 🎯 使用技巧

### 技巧1: 获得最佳识别效果

**拍照环境**:
- 🌞 光线充足（白天室内或灯光充足）
- 🚫 避免逆光（不要背对窗户）
- 🚫 避免阴影（光线均匀）

**拍照姿势**:
- 😊 正面对着摄像头
- 👀 眼睛看向摄像头
- 😐 表情自然（不要夸张表情）
- 📏 距离适中（脸部占画面的1/3-1/2）

**避免遮挡**:
- 🚫 不戴口罩
- 🚫 不戴墨镜
- 🚫 头发不遮挡脸部
- 🚫 不戴帽子

---

### 技巧2: 多次测试

如果第一次识别不准确，可以：
1. 调整光线
2. 调整角度
3. 多次拍照测试
4. 尝试不同距离

---

### 技巧3: 添加自己的照片

如果想让系统识别你：
```bash
# 在服务器上执行
venv/bin/python quick_add_face.py /path/to/your/photo.jpg 你的名字

# 例如:
venv/bin/python quick_add_face.py photo.jpg 张三

# 重启服务加载新人脸
pkill -f "python main.py"
venv/bin/python main.py &
```

---

## 📊 技术原理

### 数据流

```
本地机器                                服务器
─────────                             ─────────

1. 启动摄像头
   navigator.getUserMedia()
        │
        ↓
2. 捕获视频帧
   canvas.drawImage(video)
        │
        ↓
3. 转换为Base64
   canvas.toDataURL()
        │
        ↓
4. 上传到服务器
   POST /api/detect_stream  ────────→  5. 接收图片
   (image_data=base64)                    │
                                          ↓
                                    6. 解码图片
                                       base64 → numpy
                                          │
                                          ↓
                                    7. 人脸检测
                                       face_locations
                                          │
                                          ↓
                                    8. 提取embedding
                                       128维向量
                                          │
                                          ↓
                                    9. 比对1001个人脸
                                       计算距离
                                          │
                                          ↓
                                    10. 返回结果
11. 显示结果  ←─────────────────────  JSON response
    (姓名/Unknown)
```

### 关键技术

**前端**:
- WebRTC (getUserMedia)
- Canvas API
- Base64编码
- Fetch API

**后端**:
- FastAPI
- face_recognition库
- dlib (ResNet-34)
- OpenCV

---

## 🔒 隐私和安全

### 数据处理

1. **照片不保存**: 服务器识别后立即丢弃照片
2. **仅传输必要数据**: 只上传单张照片
3. **本地处理**: 摄像头数据不会泄露
4. **局域网通信**: 数据不经过互联网

### 代码验证

你可以查看 `local_camera_client.html` 源代码，确认：
- 只在点击"拍照"时上传一张照片
- 没有持续上传视频流
- 没有保存或发送到其他地方

---

## 📞 需要帮助？

### 常见问题

**Q: 可以在手机上使用吗？**
A: 可以！在手机浏览器访问相同地址即可。

**Q: 需要安装APP吗？**
A: 不需要！直接用浏览器访问网页即可。

**Q: 数据安全吗？**
A: 安全！数据仅在局域网传输，不经过互联网。

**Q: 识别速度能更快吗？**
A: 可以考虑使用GPU加速或减少人脸数据库大小。

---

**创建时间**: 2026-01-08
**适用版本**: 1.0.2
