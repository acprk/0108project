# 系统架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         浏览器客户端                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ 实时识别页面  │  │ 图片上传页面  │  │ 人脸管理页面  │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            │                                │
└────────────────────────────┼────────────────────────────────┘
                             │ HTTP/WebSocket
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      FastAPI 后端服务                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                      API 路由层                       │  │
│  │  /api/detect  /api/detect_stream  /api/add_face     │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
│  ┌──────────────────▼───────────────────────────────────┐  │
│  │                 业务逻辑层                             │  │
│  │  - 图片处理  - 数据验证  - 错误处理                   │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   人脸识别核心模块                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              face_detector.py                        │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │  │
│  │  │ 人脸检测    │  │ 人脸编码    │  │ 人脸比对    │    │  │
│  │  │(face_recog)│  │(dlib+CNN)  │  │(欧氏距离)   │    │  │
│  │  └────────────┘  └────────────┘  └────────────┘    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                       数据存储层                              │
│  ┌──────────────┐           ┌──────────────┐              │
│  │ 已知人脸图片  │           │  上传临时文件 │              │
│  │ (known_faces)│           │   (uploads)  │              │
│  └──────────────┘           └──────────────┘              │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 前端 (Frontend)

**技术栈**: HTML5 + CSS3 + 原生 JavaScript

**主要功能**:
- **实时视频流处理**: 使用 WebRTC getUserMedia API 获取摄像头
- **Canvas 图像处理**: 捕获视频帧并转换为 base64
- **AJAX 通信**: 与后端 API 实时交互
- **响应式 UI**: 支持桌面和移动端

**核心文件**:
- `templates/index.html`: 主页面结构
- `static/css/style.css`: 样式定义（渐变背景、卡片式布局）
- `static/js/app.js`: 前端逻辑（摄像头控制、API 调用）

### 2. 后端 (Backend)

**技术栈**: Python 3.8+ + FastAPI + Uvicorn

**主要功能**:
- **RESTful API**: 提供人脸检测、添加、查询接口
- **异步处理**: 使用 async/await 提高并发性能
- **CORS 支持**: 允许跨域请求
- **静态文件服务**: 托管前端资源

**API 端点**:
```
GET  /               # 主页
GET  /health         # 健康检查
POST /api/detect     # 图片人脸检测
POST /api/detect_stream  # 视频流检测
POST /api/add_face   # 添加已知人脸
GET  /api/known_faces    # 获取人脸列表
```

**核心文件**:
- `main.py`: FastAPI 应用主文件
  - 路由定义
  - 中间件配置
  - 全局异常处理

### 3. 人脸识别引擎 (Face Recognition Engine)

**技术栈**: face_recognition + dlib + OpenCV

**算法流程**:
```
输入图片
    ↓
[人脸定位] face_locations()
    ↓ (HOG/CNN 模型)
人脸坐标 [(top, right, bottom, left), ...]
    ↓
[特征提取] face_encodings()
    ↓ (dlib 128维特征向量)
人脸编码 [encoding_1, encoding_2, ...]
    ↓
[特征比对] compare_faces()
    ↓ (欧氏距离 < threshold)
识别结果 [name_1, name_2, ...]
```

**核心文件**:
- `face_detector.py`: FaceDetector 类
  - `load_known_faces()`: 加载已知人脸数据库
  - `detect_faces()`: 检测并识别人脸
  - `draw_faces()`: 绘制检测框
  - `add_known_face()`: 添加新人脸

**关键参数**:
- `model_type`: "hog"（快速）或 "cnn"（精确，需要 GPU）
- `tolerance`: 0.6（相似度阈值，越小越严格）

### 4. 数据层 (Data Layer)

**存储方式**: 文件系统（简化版，生产环境建议使用数据库）

**目录结构**:
```
models/
  known_faces/       # 已知人脸图片
    张三.jpg
    李四.jpg
    ...

uploads/             # 临时上传文件
```

**数据格式**:
- 图片格式: JPEG
- 命名规则: `{姓名}.jpg`
- 特征向量: 运行时加载到内存（128 维浮点数）

## 工作流程

### 实时识别流程

```
1. 用户点击"启动摄像头"
   ↓
2. 浏览器请求摄像头权限
   ↓
3. JavaScript 捕获视频帧（每 500ms）
   ↓
4. 将帧转换为 base64 编码
   ↓
5. POST 到 /api/detect_stream
   ↓
6. 后端解码图片 → 人脸检测 → 返回坐标和姓名
   ↓
7. 前端在视频上绘制人脸框和标签
   ↓
8. 循环步骤 3-7
```

### 添加人脸流程

```
1. 用户上传照片 + 输入姓名
   ↓
2. POST 到 /api/add_face
   ↓
3. 后端验证图片 → 检测人脸
   ↓
4. 提取人脸特征 → 保存到内存
   ↓
5. 保存图片到 models/known_faces/
   ↓
6. 返回成功响应
```

## 性能考量

### 优化策略

1. **人脸检测频率控制**
   - 实时模式：500ms 间隔
   - 避免过度占用 CPU/GPU

2. **图片传输优化**
   - JPEG 压缩质量：0.8
   - 视频流模式：不返回处理后的图片

3. **模型预加载**
   - 应用启动时加载所有已知人脸
   - 避免每次请求重复加载

4. **异步处理**
   - FastAPI 异步路由
   - 支持多用户并发

### 性能指标（参考）

- **单张图片检测**: 200-500ms（CPU）
- **实时识别延迟**: < 1s
- **并发支持**: 10-50 用户（取决于硬件）

## 安全性

⚠️ **当前版本为演示项目，生产环境需要增强安全性**

### 建议改进

1. **认证授权**: 添加 JWT Token
2. **数据加密**: HTTPS 传输
3. **输入验证**: 防止恶意文件上传
4. **速率限制**: 防止 API 滥用
5. **隐私保护**: 遵守 GDPR/CCPA

## 扩展性

### 可扩展方向

1. **数据库支持**
   - PostgreSQL 存储人脸特征
   - Redis 缓存

2. **分布式部署**
   - 负载均衡
   - 多服务器部署

3. **功能增强**
   - 人脸活体检测
   - 表情识别
   - 年龄/性别识别

4. **移动端**
   - React Native / Flutter APP
   - 离线识别

## 技术选型理由

| 组件 | 选择 | 理由 |
|------|------|------|
| Web 框架 | FastAPI | 高性能、异步支持、自动 API 文档 |
| 人脸识别 | face_recognition | 简单易用、精度高、基于 dlib |
| 图像处理 | OpenCV | 成熟稳定、功能全面 |
| 前端 | 原生 JS | 轻量级、无需构建工具、易于理解 |
| 部署 | Uvicorn | ASGI 服务器、支持 WebSocket |

## 依赖关系

```
face-recognition (核心)
    ├── dlib (深度学习库)
    │   └── cmake (构建工具)
    ├── numpy (数值计算)
    └── Pillow (图像处理)

FastAPI (Web 框架)
    ├── uvicorn (ASGI 服务器)
    ├── python-multipart (文件上传)
    └── starlette (核心组件)

OpenCV (计算机视觉)
    └── numpy
```

## 开发路线图

### v1.0 (当前版本)
- [x] 基础人脸检测
- [x] 实时识别
- [x] 人脸管理

### v1.1 (规划中)
- [ ] 数据库存储
- [ ] 用户认证
- [ ] 识别历史

### v2.0 (未来)
- [ ] 活体检测
- [ ] 集群部署
- [ ] 移动端 APP

---

**最后更新**: 2026-01-08
**版本**: 1.0.0
