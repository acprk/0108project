<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æ‘„åƒå¤´äººè„¸è¯†åˆ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
            color: #555;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            max-height: 600px;
            display: none;
        }

        #video.active {
            display: block;
        }

        .placeholder {
            color: #666;
            text-align: center;
            padding: 40px;
        }

        .placeholder-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        #canvas {
            display: none;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .result-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .result-item {
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .result-item.unknown {
            border-left-color: #dc3545;
        }

        .face-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .face-location {
            color: #666;
            font-size: 0.9em;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: none;
        }

        .debug-info.show {
            display: block;
        }

        .debug-info h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .debug-item {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¹ æœ¬åœ°æ‘„åƒå¤´äººè„¸è¯†åˆ«</h1>
            <p class="subtitle">åœ¨ä½ çš„æœºå™¨ä¸Šå¯åŠ¨æ‘„åƒå¤´ â†’ æ‹ç…§ â†’ ä¸Šä¼ åˆ°æœåŠ¡å™¨è¯†åˆ«</p>
        </header>

        <div class="content">
            <!-- é‡è¦æç¤º -->
            <div class="info-box">
                <h3>ğŸ“¢ é‡è¦æç¤ºï¼š</h3>
                <ul>
                    <li><strong>è¯·åœ¨æœ‰æ‘„åƒå¤´çš„æœºå™¨ä¸Šæ‰“å¼€æ­¤é¡µé¢</strong>ï¼ˆç¬”è®°æœ¬/å°å¼æœº/æ‰‹æœºï¼‰</li>
                    <li>ä½¿ç”¨ <strong>Chrome</strong>ã€<strong>Edge</strong> æˆ– <strong>Firefox</strong> æµè§ˆå™¨</li>
                    <li>ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œæµè§ˆå™¨ä¼šè¯·æ±‚æ‘„åƒå¤´æƒé™ï¼Œè¯·ç‚¹å‡»"<strong>å…è®¸</strong>"</li>
                    <li>å¦‚æœæ˜¯æ‰‹æœºè®¿é—®ï¼Œç¡®ä¿ä¸æœåŠ¡å™¨åœ¨<strong>åŒä¸€WiFi</strong>ç½‘ç»œ</li>
                </ul>
            </div>

            <!-- æœåŠ¡å™¨é…ç½® -->
            <div class="config-section">
                <h3>âš™ï¸ æœåŠ¡å™¨é…ç½®</h3>
                <div class="input-group">
                    <label for="serverUrl">æœåŠ¡å™¨åœ°å€ï¼š</label>
                    <input type="text" id="serverUrl" value="http://192.168.111.172:8001"
                           placeholder="ä¾‹å¦‚: http://192.168.111.172:8001">
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    ğŸ’¡ å¦‚æœä½ åœ¨æœåŠ¡å™¨æœ¬æœºä¸Šï¼Œå¯ä»¥ä½¿ç”¨ï¼šhttp://localhost:8001
                </p>
            </div>

            <!-- æ‘„åƒå¤´é¢„è§ˆ -->
            <div class="video-container" id="videoContainer">
                <div class="placeholder" id="placeholder">
                    <div class="placeholder-icon">ğŸ“·</div>
                    <p>ç‚¹å‡»ä¸‹æ–¹"å¯åŠ¨æ‘„åƒå¤´"æŒ‰é’®å¼€å§‹</p>
                </div>
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="btn btn-primary" id="startBtn">ğŸ¬ å¯åŠ¨æ‘„åƒå¤´</button>
                <button class="btn btn-success" id="captureBtn" disabled>ğŸ“¸ æ‹ç…§å¹¶è¯†åˆ«</button>
                <button class="btn btn-secondary" id="stopBtn" disabled>â¹ï¸ åœæ­¢æ‘„åƒå¤´</button>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="status info" id="status">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹</div>

            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="debug-info" id="debugInfo">
                <h4>ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š</h4>
                <div id="debugContent"></div>
            </div>

            <!-- è¯†åˆ«ç»“æœ -->
            <div class="result-box" id="resultBox">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('placeholder');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const resultBox = document.getElementById('resultBox');
        const resultContent = document.getElementById('resultContent');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        const serverUrlInput = document.getElementById('serverUrl');

        let stream = null;

        // è°ƒè¯•ä¿¡æ¯
        function addDebug(message) {
            const item = document.createElement('div');
            item.className = 'debug-item';
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugContent.appendChild(item);
            debugInfo.classList.add('show');
            console.log(message);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkBrowserSupport() {
            addDebug('æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...');

            // æ£€æŸ¥åŸºæœ¬å¯¹è±¡
            if (!navigator) {
                addDebug('âŒ navigator å¯¹è±¡ä¸å­˜åœ¨');
                return false;
            }
            addDebug('âœ… navigator å¯¹è±¡å­˜åœ¨');

            // æ£€æŸ¥ mediaDevices
            if (!navigator.mediaDevices) {
                addDebug('âŒ navigator.mediaDevices ä¸å­˜åœ¨');
                return false;
            }
            addDebug('âœ… navigator.mediaDevices å­˜åœ¨');

            // æ£€æŸ¥ getUserMedia
            if (!navigator.mediaDevices.getUserMedia) {
                addDebug('âŒ getUserMedia æ–¹æ³•ä¸å­˜åœ¨');
                return false;
            }
            addDebug('âœ… getUserMedia æ–¹æ³•å­˜åœ¨');

            // æ£€æŸ¥æµè§ˆå™¨ä¿¡æ¯
            const ua = navigator.userAgent;
            addDebug(`æµè§ˆå™¨: ${ua}`);

            // æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡
            const isSecure = window.location.protocol === 'https:' ||
                           window.location.hostname === 'localhost' ||
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname.startsWith('192.168.') ||
                           window.location.hostname.startsWith('10.');

            addDebug(`åè®®: ${window.location.protocol}`);
            addDebug(`ä¸»æœº: ${window.location.hostname}`);
            addDebug(`å®‰å…¨ä¸Šä¸‹æ–‡: ${isSecure ? 'æ˜¯' : 'å¦'}`);

            if (!isSecure && window.location.protocol !== 'http:') {
                addDebug('âš ï¸ éå®‰å…¨ä¸Šä¸‹æ–‡ï¼ŒæŸäº›æµè§ˆå™¨å¯èƒ½é™åˆ¶æ‘„åƒå¤´è®¿é—®');
            }

            return true;
        }

        // å¯åŠ¨æ‘„åƒå¤´
        startBtn.addEventListener('click', async () => {
            try {
                addDebug('========== å¼€å§‹å¯åŠ¨æ‘„åƒå¤´ ==========');
                updateStatus('æ­£åœ¨æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§...', 'info');

                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!checkBrowserSupport()) {
                    updateStatus('âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®', 'error');
                    updateStatus('è¯·ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Chromeã€Edge æˆ– Firefox æµè§ˆå™¨', 'error');
                    addDebug('æµè§ˆå™¨ä¸æ”¯æŒï¼Œç»ˆæ­¢æ“ä½œ');
                    return;
                }

                updateStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...', 'info');
                addDebug('è¯·æ±‚æ‘„åƒå¤´æƒé™...');

                // è¯·æ±‚æ‘„åƒå¤´è®¿é—®
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'  // å‰ç½®æ‘„åƒå¤´
                    },
                    audio: false
                };

                addDebug(`è¯·æ±‚çº¦æŸ: ${JSON.stringify(constraints)}`);

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                addDebug('âœ… æˆåŠŸè·å–åª’ä½“æµ');

                // è®¾ç½®è§†é¢‘æµ
                video.srcObject = stream;
                addDebug('è®¾ç½®è§†é¢‘æº...');

                video.onloadedmetadata = () => {
                    addDebug('âœ… è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ');
                    addDebug(`è§†é¢‘å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`);

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // æ˜¾ç¤ºè§†é¢‘
                    placeholder.style.display = 'none';
                    video.classList.add('active');

                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    startBtn.disabled = true;
                    captureBtn.disabled = false;
                    stopBtn.disabled = false;

                    updateStatus('âœ… æ‘„åƒå¤´å·²å¯åŠ¨ï¼å¯¹å‡†äººè„¸ï¼Œç‚¹å‡»"æ‹ç…§å¹¶è¯†åˆ«"', 'success');
                    addDebug('========== æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ ==========');
                };

                video.onerror = (error) => {
                    addDebug(`âŒ è§†é¢‘é”™è¯¯: ${error}`);
                    updateStatus('è§†é¢‘åŠ è½½å¤±è´¥', 'error');
                };

            } catch (error) {
                addDebug(`âŒ æ•è·é”™è¯¯: ${error.name} - ${error.message}`);
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);

                let errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼š';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'æƒé™è¢«æ‹’ç»ã€‚è¯·ç‚¹å‡»åœ°å€æ çš„æ‘„åƒå¤´å›¾æ ‡ï¼Œå…è®¸è®¿é—®æ‘„åƒå¤´ã€‚';
                    addDebug('ç”¨æˆ·æ‹’ç»äº†æ‘„åƒå¤´æƒé™');
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ã€‚è¯·ç¡®ä¿è®¾å¤‡æœ‰æ‘„åƒå¤´ã€‚';
                    addDebug('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„ç¨‹åºï¼ˆå¦‚Zoomã€Teamsç­‰ï¼‰ã€‚';
                    addDebug('æ‘„åƒå¤´è¢«å ç”¨');
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„åˆ†è¾¨ç‡ã€‚';
                    addDebug('çº¦æŸæ¡ä»¶ä¸æ»¡è¶³');
                } else if (error.name === 'TypeError') {
                    errorMessage += 'æµè§ˆå™¨ä¸æ”¯æŒæˆ–é…ç½®é”™è¯¯ã€‚';
                    addDebug('ç±»å‹é”™è¯¯');
                } else {
                    errorMessage += error.message;
                    addDebug('æœªçŸ¥é”™è¯¯');
                }

                updateStatus(errorMessage, 'error');
                addDebug('========== å¯åŠ¨å¤±è´¥ ==========');
            }
        });

        // æ‹ç…§å¹¶è¯†åˆ«
        captureBtn.addEventListener('click', async () => {
            try {
                addDebug('========== å¼€å§‹æ‹ç…§ ==========');
                updateStatus('æ­£åœ¨æ‹ç…§...', 'info');

                // æ•è·å½“å‰å¸§
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                addDebug('âœ… å›¾åƒæ•è·æˆåŠŸ');

                updateStatus('æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨è¯†åˆ«...', 'info');
                addDebug('å‡†å¤‡ä¸Šä¼ åˆ°æœåŠ¡å™¨...');

                // è·å–æœåŠ¡å™¨åœ°å€
                const serverUrl = serverUrlInput.value.trim();
                if (!serverUrl) {
                    updateStatus('âŒ è¯·å¡«å†™æœåŠ¡å™¨åœ°å€', 'error');
                    addDebug('æœåŠ¡å™¨åœ°å€ä¸ºç©º');
                    return;
                }

                addDebug(`æœåŠ¡å™¨åœ°å€: ${serverUrl}`);

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('image_data', imageData);

                addDebug('å‘é€POSTè¯·æ±‚...');

                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const response = await fetch(`${serverUrl}/api/detect_stream`, {
                    method: 'POST',
                    body: formData
                });

                addDebug(`å“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                addDebug(`è¯†åˆ«ç»“æœ: ${JSON.stringify(result)}`);

                if (result.success) {
                    displayResult(result, imageData);
                    updateStatus(`âœ… è¯†åˆ«æˆåŠŸï¼æ£€æµ‹åˆ° ${result.face_count} å¼ äººè„¸`, 'success');
                    addDebug('========== è¯†åˆ«æˆåŠŸ ==========');
                } else {
                    updateStatus('âŒ è¯†åˆ«å¤±è´¥', 'error');
                    addDebug('è¯†åˆ«å¤±è´¥: success=false');
                }

            } catch (error) {
                addDebug(`âŒ è¯†åˆ«é”™è¯¯: ${error.message}`);
                console.error('è¯†åˆ«å¤±è´¥:', error);

                let errorMessage = 'è¯†åˆ«å¤±è´¥ï¼š';

                if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ï¼š\n';
                    errorMessage += '1. æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®\n';
                    errorMessage += '2. æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ\n';
                    errorMessage += '3. ç½‘ç»œæ˜¯å¦è¿é€š';
                    addDebug('ç½‘ç»œè¿æ¥å¤±è´¥');
                } else {
                    errorMessage += error.message;
                }

                updateStatus(errorMessage, 'error');
                addDebug('========== è¯†åˆ«å¤±è´¥ ==========');
            }
        });

        // åœæ­¢æ‘„åƒå¤´
        stopBtn.addEventListener('click', () => {
            addDebug('========== åœæ­¢æ‘„åƒå¤´ ==========');

            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    addDebug(`åœæ­¢è½¨é“: ${track.kind}`);
                });
                stream = null;
            }

            video.srcObject = null;
            video.classList.remove('active');
            placeholder.style.display = 'block';

            startBtn.disabled = false;
            captureBtn.disabled = true;
            stopBtn.disabled = true;

            updateStatus('æ‘„åƒå¤´å·²åœæ­¢', 'info');
            addDebug('æ‘„åƒå¤´å·²åœæ­¢');
        });

        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        function displayResult(result, imageData) {
            let html = `<img src="${imageData}" class="result-image" style="max-width: 400px;">`;
            html += `<p><strong>æ£€æµ‹åˆ° ${result.face_count} å¼ äººè„¸ï¼š</strong></p>`;

            result.faces.forEach((face, index) => {
                const isUnknown = face.name === 'Unknown';
                html += `
                    <div class="result-item ${isUnknown ? 'unknown' : ''}">
                        <div class="face-name">äººè„¸ ${index + 1}: ${face.name}</div>
                        <div class="face-location">
                            ä½ç½®: Top=${face.location.top}, Left=${face.location.left},
                            Right=${face.location.right}, Bottom=${face.location.bottom}
                        </div>
                    </div>
                `;
            });

            resultContent.innerHTML = html;
            resultBox.classList.add('show');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', () => {
            addDebug('========== é¡µé¢åŠ è½½å®Œæˆ ==========');
            addDebug(`å½“å‰URL: ${window.location.href}`);

            // åˆ—å‡ºå¯ç”¨çš„åª’ä½“è®¾å¤‡
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        addDebug('å¯ç”¨è®¾å¤‡åˆ—è¡¨:');
                        devices.forEach(device => {
                            addDebug(`  - ${device.kind}: ${device.label || '(æ— æ ‡ç­¾)'}`);
                        });
                    })
                    .catch(err => {
                        addDebug(`æšä¸¾è®¾å¤‡å¤±è´¥: ${err.message}`);
                    });
            }
        });
    </script>
</body>
</html>
