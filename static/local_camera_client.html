<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æ‘„åƒå¤´é‡‡é›†å®¢æˆ·ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .result-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-item {
            padding: 10px;
            background: white;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æœ¬åœ°æ‘„åƒå¤´é‡‡é›†å®¢æˆ·ç«¯</h1>
            <p>åœ¨æœ¬åœ°é‡‡é›†ç…§ç‰‡ â†’ ä¸Šä¼ åˆ°æœåŠ¡å™¨è¯†åˆ«</p>
        </header>

        <div class="content">
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="config-section">
                <h3>âš™ï¸ æœåŠ¡å™¨é…ç½®</h3>
                <div class="input-group">
                    <label>æœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="serverUrl" value="http://192.168.111.172:8001"
                           placeholder="ä¾‹å¦‚: http://192.168.111.172:8001">
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    ğŸ’¡ æç¤º: å¡«å†™ä½ çš„æœåŠ¡å™¨IPåœ°å€å’Œç«¯å£
                </p>
            </div>

            <!-- æ‘„åƒå¤´é¢„è§ˆ -->
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="face-overlay" id="faceOverlay"></div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">å¯åŠ¨æœ¬åœ°æ‘„åƒå¤´</button>
                <button id="captureBtn" class="btn btn-success" disabled>æ‹ç…§å¹¶è¯†åˆ«</button>
                <button id="stopBtn" class="btn btn-secondary" disabled>åœæ­¢</button>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>

            <!-- è¯†åˆ«ç»“æœ -->
            <div id="resultBox" class="result-box" style="display: none;">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;

        // å¯åŠ¨æ‘„åƒå¤´
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                updateStatus('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...', '');

                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    updateStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®ã€‚è¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeæµè§ˆå™¨ã€‚', 'error');
                    return;
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = false;

                    updateStatus('æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œç‚¹å‡»"æ‹ç…§å¹¶è¯†åˆ«"è¿›è¡Œè¯†åˆ«', 'success');
                };

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                updateStatus('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ‹ç…§å¹¶ä¸Šä¼ è¯†åˆ«
        document.getElementById('captureBtn').addEventListener('click', async () => {
            try {
                updateStatus('æ­£åœ¨æ‹ç…§...', '');

                // æ•è·å½“å‰å¸§
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.9);

                updateStatus('æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨è¯†åˆ«...', '');

                // è·å–æœåŠ¡å™¨åœ°å€
                const serverUrl = document.getElementById('serverUrl').value.trim();
                if (!serverUrl) {
                    updateStatus('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€', 'error');
                    return;
                }

                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('image_data', imageData);

                const response = await fetch(`${serverUrl}/api/detect_stream`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    displayResult(result, imageData);
                    updateStatus(`è¯†åˆ«æˆåŠŸï¼æ£€æµ‹åˆ° ${result.face_count} å¼ äººè„¸`, 'success');
                } else {
                    updateStatus('è¯†åˆ«å¤±è´¥', 'error');
                }

            } catch (error) {
                console.error('è¯†åˆ«å¤±è´¥:', error);
                updateStatus('è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åœæ­¢æ‘„åƒå¤´
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;

            document.getElementById('startBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;

            updateStatus('æ‘„åƒå¤´å·²åœæ­¢', '');
        });

        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        function displayResult(result, imageData) {
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');

            let html = `
                <img src="${imageData}" class="result-image" style="max-width: 400px; margin-bottom: 15px;">
                <p><strong>æ£€æµ‹åˆ° ${result.face_count} å¼ äººè„¸:</strong></p>
            `;

            result.faces.forEach((face, index) => {
                const color = face.name === 'Unknown' ? '#dc3545' : '#28a745';
                html += `
                    <div class="result-item" style="border-left-color: ${color}">
                        <strong>äººè„¸ ${index + 1}:</strong> ${face.name}
                        <br><small>ä½ç½®: Top=${face.location.top}, Left=${face.location.left}</small>
                    </div>
                `;
            });

            resultContent.innerHTML = html;
            resultBox.style.display = 'block';
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status';
            if (type) statusDiv.classList.add(type);
        }
    </script>
</body>
</html>
