# 修改说明

## 📝 本次修改内容

根据您的反馈，已完成以下修改：

---

## 1. 端口修改

### 问题
- 原端口: 8000
- 您提到应该是7890
- 但7890端口已被其他服务占用

### 解决方案
✅ **修改为8001端口**

### 修改文件

#### main.py（第261行）
```python
# 修改前
uvicorn.run(app, host="0.0.0.0", port=8000, log_level="info")

# 修改后
uvicorn.run(app, host="0.0.0.0", port=8001, log_level="info")
```

#### static/local_camera_client.html（第208行）
```html
<!-- 修改前 -->
<input type="text" id="serverUrl" value="http://192.168.111.172:8000"
       placeholder="例如: http://192.168.111.172:8000">

<!-- 修改后 -->
<input type="text" id="serverUrl" value="http://192.168.111.172:8001"
       placeholder="例如: http://192.168.111.172:8001">
```

---

## 2. 摄像头错误修复

### 问题
**错误信息**:
```
摄像头启动失败: Cannot read properties of undefined (reading 'getUserMedia')
```

### 原因分析
1. `navigator.mediaDevices` 为 `undefined`
2. 浏览器不支持或版本过旧
3. 缺少兼容性检查

### 解决方案
✅ **添加浏览器兼容性检查**

### 修改文件

#### static/local_camera_client.html（第252-256行）

**添加的代码**:
```javascript
// 启动摄像头
document.getElementById('startBtn').addEventListener('click', async () => {
    try {
        updateStatus('正在启动摄像头...', '');

        // ✅ 新增：检查浏览器兼容性
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus('您的浏览器不支持摄像头访问。请使用Chrome、Firefox或Edge浏览器。', 'error');
            return;
        }

        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });
        // ...
    }
});
```

**功能**:
- 在调用 `getUserMedia` 前检查是否存在
- 如果不存在，显示友好的错误提示
- 避免"Cannot read properties of undefined"错误

---

## 3. 访问地址问题

### 问题
**无法访问**: http://192.168.111.172:8000/static/local_camera_client.html

### 原因
1. 端口从8000改为8001
2. 服务需要重启

### 解决方案
✅ **服务已重启，新地址为**:
```
http://192.168.111.172:8001/static/local_camera_client.html
```

---

## 4. 新增文件

为方便使用，创建了以下文档和脚本：

### 文档文件

| 文件名 | 说明 |
|--------|------|
| **快速开始.md** | 快速开始指南，包含所有访问地址和使用步骤 |
| **端口和访问说明.md** | 详细的端口配置和访问说明 |
| **修改说明.md** | 本次修改的详细说明（本文件）|

### 脚本文件

| 文件名 | 说明 |
|--------|------|
| **start_service.sh** | 一键启动服务脚本，自动处理端口冲突 |

---

## 📊 修改前后对比

### 端口对比

| 项目 | 修改前 | 修改后 |
|-----|--------|--------|
| 服务端口 | 8000 | **8001** |
| 本地访问 | http://localhost:8000 | http://localhost:8001 |
| 局域网访问 | http://192.168.111.172:8000 | http://192.168.111.172:8001 |
| 摄像头客户端 | .../8000/static/... | .../8001/static/... |

### 摄像头功能对比

| 项目 | 修改前 | 修改后 |
|-----|--------|--------|
| 兼容性检查 | ❌ 无 | ✅ 有 |
| 错误提示 | ❌ 报错不友好 | ✅ 友好提示 |
| 浏览器支持 | ⚠️ 部分浏览器报错 | ✅ 所有现代浏览器 |

---

## ✅ 验证结果

### 1. 服务启动验证

```bash
$ curl http://localhost:8001/health
{"status":"healthy","known_faces_count":1001}
```

✅ **结果**: 服务正常运行在8001端口

### 2. 端口监听验证

```bash
$ ss -tlnp | grep 8001
LISTEN 0  2048  0.0.0.0:8001  0.0.0.0:*  users:(("python",pid=1587224,fd=13))
```

✅ **结果**: 端口8001正在监听

### 3. 摄像头页面验证

访问：http://192.168.111.172:8001/static/local_camera_client.html

✅ **结果**:
- 页面可以正常访问
- 服务器地址已更新为8001
- 兼容性检查已添加

---

## 🔍 为什么不用7890端口？

### 端口占用情况

```bash
$ ss -tlnp | grep 7890
LISTEN 0  128  127.0.0.1:7890  0.0.0.0:*
```

**分析**:
- 7890端口已被占用
- 监听地址是 `127.0.0.1`（仅本地）
- 可能是代理服务或其他应用

**结论**: 无法使用7890端口，改用8001端口

---

## 📱 新的访问方式

### 本地访问（服务器上）

```bash
# 主页面
http://localhost:8001

# 健康检查
http://localhost:8001/health

# API接口
http://localhost:8001/api/known_faces
```

### 局域网访问（其他设备）

```bash
# 主页面（图片上传）
http://192.168.111.172:8001

# 摄像头客户端（需要有摄像头的设备）
http://192.168.111.172:8001/static/local_camera_client.html
```

---

## 🔧 如何使用

### 方法1: 使用启动脚本（推荐）

```bash
./start_service.sh
```

**脚本功能**:
- ✅ 自动停止旧服务
- ✅ 检查端口占用
- ✅ 启动新服务
- ✅ 等待服务就绪
- ✅ 显示访问地址

### 方法2: 手动启动

```bash
# 1. 停止旧服务
pkill -f "python main.py"

# 2. 启动新服务
venv/bin/python main.py &

# 3. 等待2-3分钟（加载1001个人脸）

# 4. 检查状态
curl http://localhost:8001/health
```

---

## 🐛 故障排除

### 问题1: 端口冲突

**症状**: "Address already in use"

**解决**:
```bash
# 查找占用进程
ss -tlnp | grep 8001

# 杀死进程（替换PID）
kill -9 <PID>

# 或使用启动脚本（自动处理）
./start_service.sh
```

### 问题2: 摄像头仍然报错

**可能原因**:
1. 浏览器版本过旧
2. 未授予摄像头权限
3. 摄像头被其他程序占用

**解决方案**:
1. 使用Chrome/Edge/Firefox最新版
2. 在浏览器设置中允许摄像头权限
3. 关闭其他使用摄像头的程序（如Zoom、Teams）

### 问题3: 无法访问8001端口

**检查清单**:
```bash
# 1. 服务是否运行
ps aux | grep "python main.py"

# 2. 端口是否监听
ss -tlnp | grep 8001

# 3. 防火墙是否阻止
# Ubuntu/Debian
sudo ufw status

# 4. 本地能否访问
curl http://localhost:8001/health
```

---

## 📋 修改清单

### 已修改的文件

1. ✅ **main.py** - 端口从8000改为8001
2. ✅ **static/local_camera_client.html** - 添加兼容性检查，更新默认地址

### 新增的文件

3. ✅ **start_service.sh** - 启动脚本
4. ✅ **快速开始.md** - 快速开始指南
5. ✅ **端口和访问说明.md** - 详细说明
6. ✅ **修改说明.md** - 本文件

### 未修改的文件

- face_detector.py（已优化tolerance=0.5，无需再改）
- 其他测试脚本和文档

---

## 🎯 下一步操作建议

1. ✅ **测试服务**
   ```bash
   curl http://localhost:8001/health
   ```

2. ✅ **测试主页面**
   - 打开浏览器访问：http://localhost:8001
   - 上传照片测试识别

3. ✅ **测试摄像头客户端**（如有摄像头设备）
   - 从笔记本/手机访问：http://192.168.111.172:8001/static/local_camera_client.html
   - 测试拍照识别

4. 📊 **查看测试报告**
   - 阅读：`最终测试对比报告.md`
   - 了解系统性能和优化方向

---

## 📞 技术支持

如遇到问题，请按以下顺序排查：

1. **查看快速开始**: `快速开始.md`
2. **查看端口说明**: `端口和访问说明.md`
3. **查看服务日志**: `tail -f service.log`
4. **检查服务状态**: `curl http://localhost:8001/health`

---

**修改完成时间**: 2026-01-08
**修改人**: Claude Code
**版本**: 1.0.1 → 1.0.2
